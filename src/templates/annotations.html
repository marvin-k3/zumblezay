{% extends "base.html" %}

{% block title %}Annotations{% endblock %}

{% block extra_head %}
<script type="module" src="https://cdn.jsdelivr.net/npm/media-chrome@1/+esm"></script>
<style>
    .video-container {
        position: relative;
        width: 100%;
        aspect-ratio: 16/9;
        background: #000;
    }
    .event-list {
        max-height: calc(100vh - 200px);
        overflow-y: auto;
    }
    .event-item {
        cursor: pointer;
        padding: 0.5rem !important;
    }
    .event-item:hover {
        background-color: var(--bs-tertiary-bg);
    }
    media-controller {
        width: 100%;
        height: 100%;
        --media-background-color: rgb(0 0 0);
    }
    .storyboard {
        position: relative;
        width: 100%;
        height: 60px;
        background: #000;
        overflow: hidden;
        margin-top: 0.5rem;
    }
    
    .storyboard img {
        position: absolute;
        max-width: none;
    }
    
    .storyboard-container {
        margin-top: 0.5rem;
    }
    .event-preview {
        position: absolute;
        width: 160px;
        height: 90px;
        background: #000;
        display: none;
        z-index: 1000;
        overflow: hidden;
        border: 2px solid var(--bs-border-color);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        margin-top: 4px;
    }
    
    .event-preview img {
        position: absolute;
        max-width: none;
    }
    
    .event-preview::after {
        content: '';
        position: absolute;
        top: -8px;
        left: 50%;
        transform: translateX(-50%);
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-bottom: 8px solid var(--bs-border-color);
    }
    
    .event-item {
        position: relative;
    }
    
    .filter-bar {
        background-color: var(--bs-secondary-bg);
        padding: 0.5rem;
        margin-bottom: 1rem;
        border-radius: 0.25rem;
    }
    
    .time-range-inputs {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    
    .time-range-inputs input {
        width: 100px;
    }

    .filter-form-row {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .filter-form-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .filter-form-group label {
        margin-bottom: 0;
        white-space: nowrap;
    }

    .filter-form-group input,
    .filter-form-group select {
        margin-bottom: 0;
    }
    
    /* Transcript styles */
    .transcript-container {
        margin-top: 0.75rem;
        max-height: 250px;
        overflow-y: auto;
        border: 1px solid var(--bs-border-color);
        border-radius: 0.25rem;
        padding: 0.5rem;
        background-color: var(--bs-body-bg);
    }
    
    .transcript-segment {
        margin-bottom: 0.25rem;
        padding: 0.25rem 0;
        transition: background-color 0.3s ease;
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .transcript-segment.active {
        background-color: var(--bs-primary-bg-subtle);
        border-radius: 0.25rem;
        padding: 0.25rem 0.5rem;
    }
    
    .transcript-timestamp {
        color: var(--bs-primary);
        font-weight: 500;
        margin-right: 0.25rem;
        cursor: pointer;
        user-select: none;
        white-space: nowrap;
    }
    
    .transcript-timestamp:hover {
        text-decoration: underline;
    }
    
    .transcript-text {
        display: inline;
    }
    
    .transcript-placeholder {
        color: var(--bs-secondary-color);
        font-style: italic;
        text-align: center;
        padding: 1rem 0;
    }
    
    .transcript-thumbnail {
        width: 80px;
        height: 45px;
        min-width: 80px;
        background-color: #000;
        position: relative;
        overflow: hidden;
        border-radius: 0.25rem;
        border: 1px solid var(--bs-border-color);
        transition: all 0.3s ease;
    }
    
    .transcript-thumbnail img {
        position: absolute;
        max-width: none;
        transform: scale(0.5);
        transform-origin: top left;
        transition: all 0.3s ease;
    }
    
    .large-thumbnails .transcript-thumbnail {
        width: 160px;
        height: 90px;
        min-width: 160px;
    }
    
    .large-thumbnails .transcript-thumbnail img {
        transform: scale(1);
    }
    
    .transcript-content {
        flex: 1;
    }

    .card {
        margin-bottom: 0.75rem;
    }

    .card-header {
        padding: 0.5rem 0.75rem;
    }

    .card-body {
        padding: 0.75rem;
    }

    .card-title {
        font-size: 1rem;
        margin-bottom: 0;
    }

    .transcript-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0.75rem;
        background-color: var(--bs-card-cap-bg);
        border-bottom: 1px solid var(--bs-card-border-color);
        border-top-left-radius: var(--bs-card-border-radius);
        border-top-right-radius: var(--bs-card-border-radius);
    }

    .transcript-controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .container-fluid {
        padding-left: 1rem;
        padding-right: 1rem;
    }

    .row {
        margin-left: -0.5rem;
        margin-right: -0.5rem;
    }

    .col, .col-md-3, .col-md-9 {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
    }

    .sidebar {
        transition: all 0.3s ease;
        position: relative;
    }

    .sidebar.collapsed {
        width: 40px !important;
        min-width: 40px !important;
        max-width: 40px !important;
    }

    .sidebar-toggle {
        position: absolute;
        right: -12px;
        top: 10px;
        z-index: 1000;
        background: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        padding: 0;
    }

    .sidebar-toggle:hover {
        background: var(--bs-tertiary-bg);
    }

    .sidebar.collapsed .card-body {
        display: none;
    }

    .sidebar.collapsed .card-header {
        writing-mode: vertical-rl;
        text-orientation: mixed;
        transform: rotate(180deg);
        height: 100%;
        padding: 1rem 0.5rem;
    }

    .sidebar.collapsed .card {
        height: 100%;
    }

    .main-content {
        transition: all 0.3s ease;
    }
</style>
{% endblock %}

{% block page_title %}Annotations{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="row mb-2">
        <div class="col">
            <div class="filter-bar">
                <form id="filter-form" class="filter-form-row">
                    <div class="filter-form-group">
                        <label for="date-filter" class="form-label">Date</label>
                        <input type="date" class="form-control" id="date-filter">
                    </div>
                    <div class="filter-form-group">
                        <label for="camera-filter" class="form-label">Camera</label>
                        <select class="form-select" id="camera-filter">
                            <option value="">All Cameras</option>
                        </select>
                    </div>
                    <div class="filter-form-group">
                        <label class="form-label">Time Range</label>
                        <div class="time-range-inputs">
                            <input type="time" class="form-control" id="time-start">
                            <span>to</span>
                            <input type="time" class="form-control" id="time-end">
                        </div>
                    </div>
                    <div class="filter-form-group">
                        <button type="button" class="btn btn-secondary" id="reset-filters">Reset</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-3 sidebar collapsed">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Recent Events</h5>
                </div>
                <div id="event-list" class="card-body event-list">
                    <p class="text-muted">Loading events...</p>
                </div>
                <button class="sidebar-toggle" id="sidebar-toggle" title="Toggle sidebar">
                    <i class="bi bi-chevron-left"></i>
                </button>
            </div>
        </div>
        
        <div class="col-md-9 main-content">
            <div class="card">
                <div class="card-header">
                    <h5 id="video-title" class="card-title mb-0">Select an event</h5>
                </div>
                <div class="card-body">
                    <div class="video-container">
                        <media-controller>
                            <video 
                                id="video-player"
                                slot="media"
                                preload="auto"
                                playsinline
                                muted
                                >
                                <track kind="captions" src="" label="English" default>
                            </video>
                            <media-control-bar>
                                <media-play-button></media-play-button>
                                <media-seek-backward-button seekoffset="1"></media-seek-backward-button>
                                <media-seek-forward-button seekoffset="1"></media-seek-forward-button>
                                <media-time-range></media-time-range>
                                <media-time-display></media-time-display>
                                <media-playback-rate-button></media-playback-rate-button>
                                <media-mute-button></media-mute-button>
                                <media-volume-range></media-volume-range>
                                <media-captions-button></media-captions-button>
                                <media-fullscreen-button></media-fullscreen-button>
                            </media-control-bar>
                        </media-controller>
                    </div>
                    <div class="storyboard-container">
                        <div id="storyboard" class="storyboard">
                            <img id="storyboard-img">
                        </div>
                    </div> 
                    <!-- Add transcript container -->
                    <div class="card mt-3">
                        <div class="transcript-header">
                            <h5 class="card-title mb-0">Transcript</h5>
                            <div class="transcript-controls">
                                <button id="thumbnail-size-toggle" class="btn btn-sm btn-outline-secondary" title="Toggle thumbnail size">
                                    <i class="bi bi-arrows-angle-expand"></i>
                                </button>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="auto-scroll-toggle" checked>
                                    <label class="form-check-label" for="auto-scroll-toggle">Auto-scroll</label>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div id="transcript-container" class="transcript-container">
                                <div class="transcript-placeholder">
                                    Select a video to view its transcript
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentEvent = null;
    const videoPlayer = document.getElementById('video-player');
    let transcriptData = [];
    let activeSegmentId = null;
    let autoScroll = true;
    let largeThumbnails = false;

    let currentFilters = {
        date: null,
        camera_id: '',
        timeStart: '',
        timeEnd: ''
    };

    function initializeFilters() {
        // Set default date to today
        const today = new Date();
        document.getElementById('date-filter').value = today.toLocaleDateString('en-CA'); // 'en-CA' gives YYYY-MM-DD format
        currentFilters.date = today.toLocaleDateString('en-CA');

        // Add event listeners
        document.getElementById('date-filter').addEventListener('change', updateFilters);
        document.getElementById('camera-filter').addEventListener('change', updateFilters);
        document.getElementById('time-start').addEventListener('change', updateFilters);
        document.getElementById('time-end').addEventListener('change', updateFilters);

        // Load camera list
        loadCameras();

        // Initial update
        updateFilters();
    }

    function updateFilters() {
        currentFilters = {
            date: document.getElementById('date-filter').value,
            camera_id: document.getElementById('camera-filter').value,
            timeStart: document.getElementById('time-start').value,
            timeEnd: document.getElementById('time-end').value
        };
        updateEvents();
    }

    function formatTimestamp(timestamp) {
        return new Date(timestamp * 1000).toLocaleString();
    }

    function updateEvents() {
        // Build query parameters
        const params = new URLSearchParams();
        if (currentFilters.date) {
            params.append('date', currentFilters.date);
        }
        if (currentFilters.camera_id) {
            params.append('camera_id', currentFilters.camera_id);
        }
        if (currentFilters.timeStart) {
            params.append('time_start', currentFilters.timeStart);
        }
        if (currentFilters.timeEnd) {
            params.append('time_end', currentFilters.timeEnd);
        }

        // Make API call with filters
        fetch(`/api/events?${params.toString()}`, {
            headers: { 'Accept': 'application/json' }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!Array.isArray(data)) {
                console.warn('Expected array of events, got:', typeof data);
                data = [];
            }
            
            const listDiv = document.getElementById('event-list');
            if (data.length === 0) {
                listDiv.innerHTML = '<p class="text-muted">No events available</p>';
                return;
            }

            listDiv.innerHTML = data.map(t => `
                <div class="event-item p-2 border-bottom" 
                     onclick="loadVideo('${t.event_id}')"
                     onmouseenter="startPreview('${t.event_id}', this, ${t.event_end - t.event_start})"
                     onmouseleave="stopPreview(this)">
                    <div class="fw-bold">${t.camera_name || t.camera_id}</div>
                    <div class="small text-muted">${formatTimestamp(t.event_start)} - ${Math.max(Math.round(t.event_end - t.event_start), 1)} seconds</div>
                    <div class="event-preview">
                        <img>
                    </div>
                </div>
            `).join('');
        })
        .catch(error => {
            console.error('Error fetching events:', error);
            const listDiv = document.getElementById('event-list');
            listDiv.innerHTML = '<p class="text-danger">Error loading events. Please try refreshing the page.</p>';
        });
    }

    function loadCameras() {
        fetch('/api/cameras', {
            headers: { 'Accept': 'application/json' }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data || !data.cameras || !Array.isArray(data.cameras)) {
                console.warn('Expected array of cameras, got:', data);
                return;
            }
            
            updateCameraDropdown(data.cameras);
        })
        .catch(error => {
            console.error('Error fetching cameras:', error);
        });
    }

    function updateCameraDropdown(cameras) {
        const select = document.getElementById('camera-filter');
        const currentValue = select.value;
        
        // Clear existing options except "All Cameras"
        while (select.options.length > 1) {
            select.remove(1);
        }

        // Add new options
        cameras
            .sort((a, b) => a.name.localeCompare(b.name)) // Sort by display name
            .forEach(camera => {
                const option = new Option(camera.name, camera.id);
                select.add(option);
            });

        // Restore previous selection if it still exists
        if (currentValue) {
            const cameraExists = cameras.some(camera => camera.id === currentValue);
            if (cameraExists) {
                select.value = currentValue;
            }
        }
    }

    function loadVideo(eventId) {
        // Validate eventId format - only allow alphanumeric characters and hyphens
        if (!eventId || typeof eventId !== 'string' || !/^[a-zA-Z0-9-]+$/.test(eventId)) {
            console.error('Invalid event ID format');
            return;
        }

        // Update URL without reloading the page
        const newUrl = new URL(window.location);
        newUrl.searchParams.set('video', eventId);
        window.history.pushState({}, '', newUrl);

        // Reset the transcript container
        const transcriptContainer = document.getElementById('transcript-container');
        transcriptContainer.innerHTML = '<div class="p-3 text-center"><div class="spinner-border spinner-border-sm" role="status"></div> Loading transcript...</div>';
        transcriptData = [];
        activeSegmentId = null;

        // Remove existing event listeners
        videoPlayer.removeEventListener('timeupdate', updateActiveTranscriptSegment);
        videoPlayer.removeEventListener('timeupdate', updateStoryboardPreview);

        fetch(`/api/event/${encodeURIComponent(eventId)}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data || typeof data !== 'object') {
                throw new Error('Invalid event data received');
            }

            currentEvent = data;
            const title = document.getElementById('video-title');
            
            // First remove all tracks and reset video
            videoPlayer.pause();
            
            // Remove all tracks first
            const tracks = videoPlayer.getElementsByTagName('track');
            while (tracks.length > 0) {
                tracks[0].parentNode.removeChild(tracks[0]);
            }
            
            // Clear video source and force reload
            videoPlayer.removeAttribute('src');
            videoPlayer.load();
            
            // Wait for video reset before adding new content
            setTimeout(() => {
                // Set new video source
                videoPlayer.src = `/video/${encodeURIComponent(eventId)}`;
                
                // Add caption track if transcription exists
                if (data.has_transcript) {
                    const captionTrack = document.createElement('track');
                    captionTrack.kind = 'captions';
                    captionTrack.label = 'English';
                    captionTrack.src = `/api/captions/${encodeURIComponent(eventId)}`;
                    captionTrack.default = true;
                    videoPlayer.appendChild(captionTrack);
                    
                    // Load the transcript
                    loadTranscript(eventId);
                } else {
                    // No transcript available
                    transcriptContainer.innerHTML = '<div class="transcript-placeholder">No transcript available for this video</div>';
                }

                // Add storyboard track
                const storyboardTrack = document.createElement('track');
                storyboardTrack.kind = 'metadata';
                storyboardTrack.label = 'thumbnails';
                storyboardTrack.src = `/api/storyboard/vtt/${encodeURIComponent(eventId)}`;
                storyboardTrack.default = true;
                videoPlayer.appendChild(storyboardTrack);
                
                let titleText = `${data.camera_name || data.camera_id} - ${formatTimestamp(data.event_start)}`;
                if (!data.has_transcript) {
                    titleText += ' (Transcription pending)';
                }
                title.textContent = titleText;
            }, 100);
        })
        .catch(error => {
            console.error('Error loading event:', error);
            document.getElementById('video-title').textContent = 'Error loading video';
            // Remove video parameter from URL on error
            const newUrl = new URL(window.location);
            newUrl.searchParams.delete('video');
            window.history.pushState({}, '', newUrl);
            
            // Clear transcript
            transcriptContainer.innerHTML = '<div class="transcript-placeholder">Error loading transcript</div>';
        });
    }

    function updateStoryboardPreview() {
        const video = videoPlayer;
        const storyboardImg = document.getElementById('storyboard-img');
        
        // Add null checks and verify textTracks exists
        if (!video || !video.textTracks || video.textTracks.length < 2) {
            return;
        }
        
        const track = video.textTracks[1]; // metadata track
        if (!track || !track.cues || track.cues.length === 0) {
            return;
        }
        
        const currentTime = video.currentTime;
        for (let i = 0; i < track.cues.length; i++) {
            const cue = track.cues[i];
            if (currentTime >= cue.startTime && currentTime <= cue.endTime) {
                try {
                    const data = JSON.parse(cue.text);
                    const [x, y, width, height] = data.xywh;
                    storyboardImg.style.left = `-${x}px`;
                    storyboardImg.style.top = `-${y}px`;
                } catch (error) {
                    console.error('Error parsing storyboard cue:', error);
                }
                break;
            }
        }
    }

    // Handle browser back/forward buttons
    window.addEventListener('popstate', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const videoId = urlParams.get('video');
        if (videoId) {
            loadVideo(videoId);
        } else {
            // Clear video if no video parameter
            videoPlayer.src = '';
            document.getElementById('video-title').textContent = 'Select an event';
            currentEvent = null;
        }
    });

    // Update immediately and then every 5 seconds
    updateEvents();

    // Add these new functions for preview handling
    let currentPreviewInterval = null;
    let previewVttData = {};

    async function startPreview(eventId, element, duration) {
        const preview = element.querySelector('.event-preview');
        const previewImg = preview.querySelector('img');
        
        // Show preview and set initial image immediately
        preview.style.display = 'block';
        previewImg.src = `/api/storyboard/image/${eventId}`;
        
        // Clear any existing interval
        if (currentPreviewInterval) {
            clearInterval(currentPreviewInterval);
        }

        // Start loading VTT data if not already cached
        if (!previewVttData[eventId]) {
            try {
                const response = await fetch(`/api/storyboard/vtt/${eventId}`);
                const vttText = await response.text();
                previewVttData[eventId] = parseVTT(vttText);
            } catch (error) {
                console.error('Error loading preview VTT:', error);
                return;
            }
        }

        let currentTime = 0;
        const fps = 4;

        // Start animation loop immediately after VTT data is available
        currentPreviewInterval = setInterval(() => {
            currentTime = (currentTime + 1) % Math.ceil(duration);
            const frame = previewVttData[eventId].find(f => 
                currentTime >= f.startTime && currentTime <= f.endTime
            );
            
            if (frame) {
                const [x, y, width, height] = frame.position;
                previewImg.style.left = `-${x}px`;
                previewImg.style.top = `-${y}px`;
            }
        }, 1000 / fps);
    }

    function stopPreview(element) {
        const preview = element.querySelector('.event-preview');
        preview.style.display = 'none';
        
        if (currentPreviewInterval) {
            clearInterval(currentPreviewInterval);
            currentPreviewInterval = null;
        }
    }

    function parseVTT(vttText) {
        const frames = [];
        const lines = vttText.split('\n');
        let currentFrame = null;

        for (const line of lines) {
            if (line.includes('-->')) {
                const [start, end] = line.split('-->').map(timeStr => {
                    const [h, m, s] = timeStr.trim().split(':').map(Number);
                    return h * 3600 + m * 60 + s;
                });
                currentFrame = { startTime: start, endTime: end };
            } else if (line.includes('#xywh=') && currentFrame) {
                const xywh = line.split('#xywh=')[1].split(',').map(Number);
                currentFrame.position = xywh;
                frames.push(currentFrame);
                currentFrame = null;
            }
        }

        return frames;
    }

    function resetFilters() {
        // Reset filter values to default
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date-filter').value = today;
        document.getElementById('camera-filter').value = '';
        document.getElementById('time-start').value = '';
        document.getElementById('time-end').value = '';
        currentFilters = {
            date: today,
            camera_id: '',
            timeStart: '',
            timeEnd: ''
        };
        updateEvents(); // Refresh events with reset filters
    }

    document.getElementById('reset-filters').addEventListener('click', resetFilters);

    function formatTimeDisplay(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);
        
        if (hours > 0) {
            return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        } else {
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }
    }

    function loadTranscript(eventId) {
        fetch(`/api/captions/${encodeURIComponent(eventId)}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.text();
        })
        .then(vttContent => {
            transcriptData = parseTranscriptVTT(vttContent);
            renderTranscript();
            
            // Add timeupdate event listener to highlight current segment
            videoPlayer.addEventListener('timeupdate', updateActiveTranscriptSegment);
            
            // Also listen for video timeupdate to update storyboard
            videoPlayer.addEventListener('timeupdate', updateStoryboardPreview);
        })
        .catch(error => {
            console.error('Error loading transcript:', error);
            const transcriptContainer = document.getElementById('transcript-container');
            transcriptContainer.innerHTML = '<div class="transcript-placeholder">Error loading transcript</div>';
        });
    }

    function parseTranscriptVTT(vttContent) {
        const lines = vttContent.split('\n');
        const segments = [];
        let currentSegment = null;

        // Skip WebVTT header
        let i = 0;
        while (i < lines.length && !lines[i].includes('-->')) {
            i++;
        }

        // Parse cues
        for (; i < lines.length; i++) {
            const line = lines[i].trim();
            
            if (line.includes('-->')) {
                // This is a timestamp line
                const [start, end] = line.split('-->').map(t => {
                    // Parse timestamp like "00:00:01.000"
                    const parts = t.trim().split(':');
                    const seconds = parseFloat(parts[parts.length-1]);
                    const minutes = parseInt(parts[parts.length-2]);
                    const hours = parts.length > 2 ? parseInt(parts[0]) : 0;
                    return hours * 3600 + minutes * 60 + seconds;
                });
                
                currentSegment = {
                    id: `segment-${segments.length}`,
                    start,
                    end,
                    text: ''
                };
            } else if (line !== '' && currentSegment) {
                // This is a text line
                currentSegment.text += (currentSegment.text ? ' ' : '') + line;
            } else if (line === '' && currentSegment && currentSegment.text) {
                // End of segment
                segments.push(currentSegment);
                currentSegment = null;
            }
        }

        // Add the last segment if it exists
        if (currentSegment && currentSegment.text) {
            segments.push(currentSegment);
        }

        return segments;
    }

    function renderTranscript() {
        const transcriptContainer = document.getElementById('transcript-container');
        
        if (transcriptData.length === 0) {
            transcriptContainer.innerHTML = '<div class="transcript-placeholder">No transcript available</div>';
            return;
        }
        
        const html = transcriptData.map(segment => `
            <div id="${segment.id}" class="transcript-segment">
                <div class="transcript-thumbnail" onclick="seekToTime(${segment.start})">
                    <img src="/api/storyboard/image/${currentEvent.event_id}" data-segment-time="${segment.start}" alt="Preview">
                </div>
                <div class="transcript-content">
                    <span class="transcript-timestamp" onclick="seekToTime(${segment.start})">
                        ${formatTimeDisplay(segment.start)}
                    </span>
                    <span class="transcript-text">${segment.text}</span>
                </div>
            </div>
        `).join('');
        
        transcriptContainer.innerHTML = html;
        
        // Initialize thumbnails
        updateThumbnailPositions();
    }

    function updateThumbnailPositions() {
        if (!transcriptData.length || !currentEvent) return;
        
        // Load storyboard VTT data if not already loaded
        if (!previewVttData[currentEvent.event_id]) {
            fetch(`/api/storyboard/vtt/${currentEvent.event_id}`)
            .then(response => response.text())
            .then(vttText => {
                previewVttData[currentEvent.event_id] = parseVTT(vttText);
                positionThumbnailImages();
            })
            .catch(error => {
                console.error('Error loading storyboard VTT data:', error);
            });
        } else {
            positionThumbnailImages();
        }
    }

    function positionThumbnailImages() {
        if (!currentEvent || !previewVttData[currentEvent.event_id]) return;
        
        const vttData = previewVttData[currentEvent.event_id];
        const thumbnailImages = document.querySelectorAll('.transcript-thumbnail img');
        
        thumbnailImages.forEach(img => {
            const segmentTime = parseFloat(img.dataset.segmentTime);
            const frame = findFrameForTime(vttData, segmentTime);
            
            if (frame) {
                // The original storyboard image has thumbs of 160x90px
                const [x, y, width, height] = frame.position;
                
                if (largeThumbnails) {
                    // Use original size for large thumbnails
                    img.style.left = `-${x}px`;
                    img.style.top = `-${y}px`;
                } else {
                    // Scale down for small thumbnails
                    img.style.left = `-${x / 2}px`;
                    img.style.top = `-${y / 2}px`;
                }
            }
        });
    }

    function findFrameForTime(vttData, time) {
        return vttData.find(frame => time >= frame.startTime && time <= frame.endTime) || 
               (time > vttData[vttData.length - 1]?.endTime ? vttData[vttData.length - 1] : vttData[0]);
    }

    function seekToTime(seconds) {
        if (videoPlayer) {
            videoPlayer.currentTime = seconds;
            videoPlayer.play().catch(e => console.error('Error playing video:', e));
        }
    }

    function updateActiveTranscriptSegment() {
        if (!videoPlayer || transcriptData.length === 0) return;
        
        const currentTime = videoPlayer.currentTime;
        let activeSegment = null;
        
        // Find the current segment
        for (const segment of transcriptData) {
            if (currentTime >= segment.start && currentTime <= segment.end) {
                activeSegment = segment;
                break;
            }
        }
        
        // If no segment found but we're after the last segment's end time,
        // consider the last segment as active
        if (!activeSegment && currentTime > transcriptData[transcriptData.length - 1].end) {
            activeSegment = transcriptData[transcriptData.length - 1];
        }
        
        // If no segment is active or it's the same as before, do nothing
        if (!activeSegment || (activeSegmentId && activeSegment.id === activeSegmentId)) {
            return;
        }
        
        // Remove active class from previous segment
        if (activeSegmentId) {
            const prevElement = document.getElementById(activeSegmentId);
            if (prevElement) {
                prevElement.classList.remove('active');
            }
        }
        
        // Add active class to current segment
        const currentElement = document.getElementById(activeSegment.id);
        if (currentElement) {
            currentElement.classList.add('active');
            activeSegmentId = activeSegment.id;
            
            // Auto-scroll to active segment if enabled
            if (autoScroll) {
                const container = document.getElementById('transcript-container');
                const elementTop = currentElement.offsetTop;
                const containerHeight = container.clientHeight;
                const scrollPosition = elementTop - (containerHeight / 2);
                
                container.scrollTo({
                    top: scrollPosition,
                    behavior: 'smooth'
                });
            }
        }
    }

    // Toggle auto-scrolling and thumbnail size
    document.addEventListener('DOMContentLoaded', function() {
        const autoScrollToggle = document.getElementById('auto-scroll-toggle');
        autoScrollToggle.addEventListener('change', function() {
            autoScroll = this.checked;
        });
        
        // Add thumbnail size toggle functionality
        const thumbnailSizeToggle = document.getElementById('thumbnail-size-toggle');
        thumbnailSizeToggle.addEventListener('click', function() {
            largeThumbnails = !largeThumbnails;
            const container = document.getElementById('transcript-container');
            
            if (largeThumbnails) {
                container.classList.add('large-thumbnails');
                this.innerHTML = '<i class="bi bi-arrows-angle-contract"></i>';
            } else {
                container.classList.remove('large-thumbnails');
                this.innerHTML = '<i class="bi bi-arrows-angle-expand"></i>';
            }
            
            // Update positions of thumbnails based on new size
            positionThumbnailImages();
        });
        
        // Add loadedmetadata event listener to the video player
        videoPlayer.addEventListener('loadedmetadata', function() {
            if (currentEvent && transcriptData.length > 0) {
                updateThumbnailPositions();
            }
        });
        
        // Initialize filters when page loads
        initializeFilters();
        
        // Check if there's a video ID in the URL
        const urlParams = new URLSearchParams(window.location.search);
        const videoId = urlParams.get('video');
        if (videoId) {
            loadVideo(videoId);
        }

        // Add sidebar toggle functionality
        const sidebar = document.querySelector('.sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const mainContent = document.querySelector('.main-content');
        
        // Check if sidebar state is saved
        const sidebarState = localStorage.getItem('sidebarCollapsed');
        if (sidebarState === 'true') {
            sidebar.classList.add('collapsed');
            mainContent.classList.add('col-md-12');
            mainContent.classList.remove('col-md-9');
            sidebarToggle.querySelector('i').classList.replace('bi-chevron-left', 'bi-chevron-right');
        }

        sidebarToggle.addEventListener('click', function() {
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('col-md-12');
            mainContent.classList.toggle('col-md-9');
            
            // Update icon
            const icon = this.querySelector('i');
            if (sidebar.classList.contains('collapsed')) {
                icon.classList.replace('bi-chevron-left', 'bi-chevron-right');
                localStorage.setItem('sidebarCollapsed', 'true');
            } else {
                icon.classList.replace('bi-chevron-right', 'bi-chevron-left');
                localStorage.setItem('sidebarCollapsed', 'false');
            }
        });
    });

    // This function needs to be global to be called from the HTML
    window.seekToTime = seekToTime;
</script>
{% endblock %} 