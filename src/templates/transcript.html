{% extends "base.html" %}

{% block title %}Transcript{% endblock %}

{% block page_title %}Daily Transcript{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<style>
    /* General improvements */
    .date-picker {
        max-width: 100%;
        width: 100%;
    }
    .transcript-container {
        margin-top: 20px;
        padding: 20px;
        border: 1px solid var(--bs-border-color);
        border-radius: 5px;
        background-color: var(--bs-secondary-bg);
        position: relative;
    }
    .transcript-controls {
        margin-bottom: 15px;
    }
    .transcript-content {
        margin-top: 15px;
        overflow-wrap: break-word;
        word-wrap: break-word;
        max-height: 600px;
        overflow-y: auto;
    }
    .search-bar {
        margin-bottom: 15px;
    }
    .transcript-metadata {
        font-size: 0.8rem;
        color: #666;
        margin-bottom: 10px;
    }
    .loading {
        display: none;
        margin: 20px 0;
    }
    .transcript-entry {
        padding: 10px;
        border-bottom: 1px solid var(--bs-border-color);
        transition: background-color 0.2s ease;
        cursor: pointer;
    }
    .transcript-entry:hover {
        background-color: var(--bs-tertiary-bg);
    }
    .transcript-entry:last-child {
        border-bottom: none;
    }
    .transcript-time {
        font-weight: bold;
        color: var(--bs-primary);
    }
    .transcript-camera {
        font-size: 0.9rem;
        color: var(--bs-secondary);
        font-style: italic;
    }
    .transcript-text {
        margin-top: 5px;
    }
    .transcript-action {
        margin-top: 8px;
        text-align: right;
    }
    .transcript-action-button {
        font-size: 0.8rem;
        padding: 2px 8px;
    }
    .search-highlight {
        background-color: rgba(255, 255, 0, 0.4);
        padding: 2px 0;
        border-radius: 2px;
    }
    .search-count {
        position: absolute;
        right: 20px;
        top: 20px;
        font-size: 0.9rem;
    }
    .hidden {
        display: none;
    }
    .no-results {
        text-align: center;
        padding: 20px;
        color: var(--bs-gray);
    }
    
    /* Navigation controls for search results */
    .search-navigation {
        display: none;
        margin-top: 10px;
    }
    .search-navigation button {
        margin-right: 5px;
    }
    .search-result-active {
        background-color: rgba(255, 165, 0, 0.3);
        border-left: 3px solid var(--bs-warning);
    }
    
    /* Responsive layout improvements */
    @media (max-width: 767.98px) {
        .controls-container {
            margin-bottom: 20px;
        }
        
        .controls-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--bs-tertiary-bg);
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            border: 1px solid var(--bs-border-color);
            cursor: pointer;
        }
        
        .controls-content {
            display: none;
        }
        
        .controls-content.show {
            display: block;
        }
        
        .controls-toggle-icon {
            transition: transform 0.3s ease;
        }
        
        .controls-toggle.active .controls-toggle-icon {
            transform: rotate(180deg);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Mobile toggle for controls (only visible on small screens) -->
    <div class="col-12 d-md-none mb-3">
        <div class="controls-toggle" id="controls-toggle">
            <span><i class="bi bi-gear me-2"></i>Transcript Controls</span>
            <i class="bi bi-chevron-down controls-toggle-icon"></i>
        </div>
    </div>

    <!-- Controls column - will stack on mobile -->
    <div class="col-md-4 controls-container">
        <div class="controls-content d-md-block">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-calendar-date"></i> Select Date</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="date-picker" class="form-label">Date</label>
                        <input type="date" class="form-control date-picker" id="date-picker">
                    </div>
                    <div class="d-grid">
                        <button id="load-transcript" class="btn btn-primary btn-sm">
                            <i class="bi bi-arrow-clockwise"></i> Load Transcript
                        </button>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h5><i class="bi bi-search"></i> Search Options</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="search-input" class="form-label">Search Transcript</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="search-input" placeholder="Enter search term...">
                            <button class="btn btn-outline-secondary" type="button" id="search-button">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="case-sensitive">
                        <label class="form-check-label" for="case-sensitive">Case sensitive</label>
                    </div>
                    <div class="search-navigation">
                        <button id="prev-result" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-arrow-up"></i> Previous
                        </button>
                        <button id="next-result" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-arrow-down"></i> Next
                        </button>
                        <span id="result-counter" class="ms-2 text-muted">0 of 0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Content column -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="bi bi-chat-text"></i> Transcript</h5>
                <div class="search-count" id="search-count"></div>
            </div>
            <div class="card-body">
                <div class="transcript-metadata" id="transcript-metadata"></div>
                
                <div id="transcript-content" class="transcript-content">
                    <div class="text-center p-5 text-muted">
                        <i class="bi bi-calendar-date fs-1"></i>
                        <p class="mt-3">Select a date and click "Load Transcript" to view the daily transcript.</p>
                    </div>
                </div>
                
                <div class="loading" id="loading">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <p class="text-center mt-2">
                        <i class="bi bi-cpu"></i> Loading transcript data...
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Define urlParams in the global scope so it can be accessed by all functions
    const urlParams = new URLSearchParams(window.location.search);
    
    // Get the timezone from the server - use safe rendering to prevent HTML encoding
    const appTimezone = "{{timezone | safe}}";
    console.log("Using timezone:", appTimezone);
    
    // Validate the timezone to ensure it's in the correct format
    function isValidTimezone(tz) {
        try {
            Intl.DateTimeFormat(undefined, {timeZone: tz});
            return true;
        } catch (e) {
            console.error(`Invalid timezone: ${tz}`, e);
            return false;
        }
    }
    
    // Use a fallback timezone if the server-provided one is invalid
    const validTimezone = isValidTimezone(appTimezone) ? appTimezone : "Australia/Adelaide";
    
    // Variables for search functionality
    let currentSearchResults = [];
    let currentSearchIndex = -1;
    let transcriptData = [];
    
    document.addEventListener('DOMContentLoaded', function() {
        // Set up the controls toggle for mobile view
        const controlsToggle = document.getElementById('controls-toggle');
        if (controlsToggle) {
            controlsToggle.addEventListener('click', function() {
                const controlsContent = document.querySelector('.controls-content');
                controlsContent.classList.toggle('show');
                this.classList.toggle('active');
            });
        }
        
        // Set default date to today in server timezone or from URL parameter
        const dateParam = urlParams.get('date');
        const dateInput = document.getElementById('date-picker');
        
        if (dateParam) {
            // Use date from URL
            dateInput.value = dateParam;
            // Load transcript for date from URL
            loadTranscript();
        } else {
            // Use today's date in server timezone
            const today = new Date();
            const localizedDate = convertToServerTimezone(today);
            dateInput.value = formatDateForInput(localizedDate);
        }
        
        // Update URL when date changes
        dateInput.addEventListener('change', function() {
            updateUrlParams('date', this.value);
        });
        
        // Load transcript button click handler
        document.getElementById('load-transcript').addEventListener('click', function() {
            loadTranscript();
        });
        
        // Set up search functionality
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        
        // Search when the button is clicked
        searchButton.addEventListener('click', function() {
            searchTranscript();
        });
        
        // Search when Enter key is pressed in the input field
        searchInput.addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                searchTranscript();
            }
        });
        
        // Navigation for search results
        document.getElementById('prev-result').addEventListener('click', function() {
            navigateSearchResults('prev');
        });
        
        document.getElementById('next-result').addEventListener('click', function() {
            navigateSearchResults('next');
        });
        
        // Handle case sensitive checkbox changes
        document.getElementById('case-sensitive').addEventListener('change', function() {
            if (searchInput.value.trim()) {
                searchTranscript();
            }
        });
    });
    
    // Function to update URL parameters without reloading the page
    function updateUrlParams(key, value) {
        const url = new URL(window.location);
        url.searchParams.set(key, value);
        window.history.pushState({}, '', url);
    }
    
    // Function to convert a date to server timezone
    function convertToServerTimezone(date) {
        try {
            return new Date(date.toLocaleString('en-US', { timeZone: validTimezone }));
        } catch (error) {
            console.error(`Error converting to timezone ${validTimezone}: ${error.message}`);
            console.log("Falling back to local timezone");
            return new Date(date);
        }
    }
    
    // Function to format a date for the date input (YYYY-MM-DD)
    function formatDateForInput(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    // Function to view video for a specific event
    function viewVideo(eventId) {
        // Navigate to the events page with the video parameter
        window.location.href = `/events?video=${eventId}`;
    }
    
    // Load transcript data for the selected date
    function loadTranscript() {
        const date = document.getElementById('date-picker').value;
        if (!date) {
            alert('Please select a date');
            return;
        }
        
        // Update URL with current date
        updateUrlParams('date', date);
        
        // Show loading indicator
        document.getElementById('loading').style.display = 'block';
        
        // Clear previous content and search results
        document.getElementById('transcript-content').innerHTML = '';
        document.getElementById('transcript-metadata').innerHTML = '';
        document.getElementById('search-count').innerHTML = '';
        document.getElementById('search-input').value = '';
        document.querySelector('.search-navigation').style.display = 'none';
        currentSearchResults = [];
        currentSearchIndex = -1;
        transcriptData = [];
        
        // Load JSON data for transcripts
        fetch(`/api/transcripts/json/${date}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('No transcript data available');
                }
                return response.json();
            })
            .then(data => {
                transcriptData = data.transcripts;
                displayTranscript(data, date);
                document.getElementById('loading').style.display = 'none';
            })
            .catch(error => {
                console.error('Error loading transcript data:', error);
                document.getElementById('transcript-content').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> No transcript data available for this date.
                    </div>`;
                document.getElementById('loading').style.display = 'none';
            });
    }
    
    // Function to display the transcript data
    function displayTranscript(data, date) {
        const transcriptContent = document.getElementById('transcript-content');
        
        // Check if we have any transcripts
        if (!data.transcripts || data.transcripts.length === 0) {
            transcriptContent.innerHTML = '<div class="no-results">No transcript data available for this date.</div>';
            return;
        }
        
        // Create transcript entries
        let transcriptHTML = '';
        
        // Create HTML for each transcript entry
        data.transcripts.forEach((entry, index) => {
            transcriptHTML += `
            <div class="transcript-entry" data-time="${entry.time}" data-camera="${entry.camera}" data-event-id="${entry.event_id}" data-index="${index}">
                <div class="d-flex justify-content-between">
                    <span class="transcript-time">${entry.time}</span>
                    <span class="transcript-camera">${entry.camera}</span>
                </div>
                <div class="transcript-text">${entry.text}</div>
                <div class="transcript-action">
                    <button class="btn btn-sm btn-outline-primary transcript-action-button" onclick="viewVideo('${entry.event_id}')">
                        <i class="bi bi-camera-video"></i> View Video
                    </button>
                </div>
            </div>`;
        });
        
        if (transcriptHTML) {
            transcriptContent.innerHTML = transcriptHTML;
            
            // Update metadata with date information
            updateTranscriptMetadata(date);
            
            // Add click event to transcript entries
            document.querySelectorAll('.transcript-entry').forEach(entry => {
                entry.addEventListener('click', function(e) {
                    // Don't trigger if they clicked the button
                    if (e.target.closest('.transcript-action-button')) {
                        return;
                    }
                    
                    const eventId = this.getAttribute('data-event-id');
                    viewVideo(eventId);
                });
            });
        } else {
            transcriptContent.innerHTML = '<div class="no-results">No transcript data available for this date.</div>';
        }
    }
    
    // Update the transcript metadata
    function updateTranscriptMetadata(date) {
        // Parse the date and format it in server timezone
        const [year, month, day] = date.split('-').map(Number);
        const dateObj = new Date(Date.UTC(year, month - 1, day));
        const localizedDate = convertToServerTimezone(dateObj);
        
        const formattedDate = localizedDate.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            timeZone: validTimezone
        });
        
        document.getElementById('transcript-metadata').innerHTML = 
            `<strong>${formattedDate}</strong> <span class="text-muted">(${validTimezone})</span>`;
    }
    
    // Function to search the transcript
    function searchTranscript() {
        const searchTerm = document.getElementById('search-input').value.trim();
        const isCaseSensitive = document.getElementById('case-sensitive').checked;
        const transcriptContent = document.getElementById('transcript-content');
        const searchCount = document.getElementById('search-count');
        const resultCounter = document.getElementById('result-counter');
        
        // Reset previous search
        document.querySelectorAll('.search-highlight').forEach(el => {
            const text = el.textContent;
            el.outerHTML = text;
        });
        
        document.querySelectorAll('.transcript-entry').forEach(entry => {
            entry.classList.remove('search-result-active', 'hidden');
        });
        
        // Hide search navigation
        document.querySelector('.search-navigation').style.display = 'none';
        
        if (!searchTerm) {
            searchCount.innerHTML = '';
            return;
        }
        
        // Create a regular expression for searching
        const regex = isCaseSensitive 
            ? new RegExp(escapeRegExp(searchTerm), 'g')
            : new RegExp(escapeRegExp(searchTerm), 'gi');
        
        // Get all transcript entries
        const entries = document.querySelectorAll('.transcript-entry');
        
        // Count matches and highlight them
        let totalMatches = 0;
        currentSearchResults = [];
        
        entries.forEach((entry, entryIndex) => {
            const textElement = entry.querySelector('.transcript-text');
            const text = textElement.textContent;
            
            let match;
            let lastIndex = 0;
            let matches = 0;
            let highlightedText = '';
            
            // Reset the regex lastIndex
            regex.lastIndex = 0;
            
            while ((match = regex.exec(text)) !== null) {
                matches++;
                
                // Add text before the match
                highlightedText += text.substring(lastIndex, match.index);
                
                // Add the highlighted match
                highlightedText += `<span class="search-highlight" data-entry-index="${entryIndex}" data-match-index="${totalMatches}">${match[0]}</span>`;
                
                // Update lastIndex to the end of the current match
                lastIndex = regex.lastIndex;
                
                // Store the search result
                currentSearchResults.push({
                    entryIndex,
                    matchIndex: totalMatches
                });
                
                totalMatches++;
            }
            
            // Add any remaining text
            highlightedText += text.substring(lastIndex);
            
            if (matches > 0) {
                textElement.innerHTML = highlightedText;
            } else {
                entry.classList.add('hidden');
            }
        });
        
        // Update search count
        if (totalMatches > 0) {
            searchCount.innerHTML = `<span class="badge bg-primary">${totalMatches} matches</span>`;
            
            // Show search navigation
            document.querySelector('.search-navigation').style.display = 'block';
            
            // Reset current search index
            currentSearchIndex = -1;
            resultCounter.textContent = `0 of ${totalMatches}`;
            
            // Navigate to first result
            navigateSearchResults('next');
        } else {
            searchCount.innerHTML = '<span class="badge bg-secondary">No matches</span>';
            
            // Show message when no results found
            transcriptContent.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> No matches found for "${searchTerm}".
                    <button class="btn btn-sm btn-outline-primary float-end" onclick="loadTranscript()">
                        <i class="bi bi-arrow-clockwise"></i> Reset
                    </button>
                </div>`;
        }
    }
    
    // Function to navigate between search results
    function navigateSearchResults(direction) {
        if (currentSearchResults.length === 0) return;
        
        if (direction === 'next') {
            currentSearchIndex = (currentSearchIndex + 1) % currentSearchResults.length;
        } else {
            currentSearchIndex = (currentSearchIndex - 1 + currentSearchResults.length) % currentSearchResults.length;
        }
        
        const result = currentSearchResults[currentSearchIndex];
        
        // Remove active class from all entries
        document.querySelectorAll('.transcript-entry').forEach(entry => {
            entry.classList.remove('search-result-active');
        });
        
        // Find the matching entry and highlight
        const entry = document.querySelectorAll('.transcript-entry')[result.entryIndex];
        entry.classList.add('search-result-active');
        
        // Scroll to the entry
        entry.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Update the counter
        document.getElementById('result-counter').textContent = 
            `${currentSearchIndex + 1} of ${currentSearchResults.length}`;
    }
    
    // Helper function to escape special characters in regex
    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }
    
    // Helper function to parse CSV rows
    function parseCSVRow(row) {
        const result = [];
        let insideQuotes = false;
        let currentValue = '';
        
        for (let i = 0; i < row.length; i++) {
            const char = row[i];
            
            if (char === '"') {
                if (i < row.length - 1 && row[i + 1] === '"') {
                    // Handle escaped quotes
                    currentValue += '"';
                    i++;
                } else {
                    // Toggle inside quotes flag
                    insideQuotes = !insideQuotes;
                }
            } else if (char === ',' && !insideQuotes) {
                // End of cell
                result.push(currentValue);
                currentValue = '';
            } else {
                // Add character to current value
                currentValue += char;
            }
        }
        
        // Add the last value
        result.push(currentValue);
        
        return result;
    }
</script>
{% endblock %} 