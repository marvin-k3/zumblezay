{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_head %}
<script type="module" src="https://cdn.jsdelivr.net/npm/media-chrome@1/+esm"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<style>
    .video-container {
        position: relative;
        width: 100%;
    }
    .event-list {
        max-height: 640px;
        overflow-y: auto;
    }
    .event-item {
        cursor: pointer;
        position: relative;
    }
    .event-item:hover {
        background-color: var(--bs-tertiary-bg);
    }
    media-controller {
        width: 100%;
        height: 400px;
        --media-background-color: rgb(0 0 0);
    }
    .event-preview {
        position: absolute;
        width: 160px;
        height: 90px;
        background: #000;
        display: none;
        z-index: 1000;
        overflow: hidden;
        border: 2px solid var(--bs-border-color);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        margin-top: 8px;
    }
    .event-preview img {
        position: absolute;
        max-width: none;
    }
    .event-preview::after {
        content: '';
        position: absolute;
        top: -8px;
        left: 50%;
        transform: translateX(-50%);
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-bottom: 8px solid var(--bs-border-color);
    }
    .filter-bar {
        background-color: var(--bs-secondary-bg);
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 0.25rem;
        border: 1px solid var(--bs-border-color);
    }
    .time-range-inputs {
        display: flex;
        gap: 0.75rem;
        align-items: center;
    }
    .time-range-inputs input {
        width: 120px;
    }
    .filter-hint {
        font-size: 0.9rem;
        color: var(--bs-secondary-color);
    }
    .results-meta {
        font-size: 0.9rem;
        color: var(--bs-secondary-color);
    }
    .match-quality {
        font-size: 0.8rem;
        color: var(--bs-secondary-color);
    }
    .match-quality .label {
        font-weight: 600;
        color: var(--bs-body-color);
    }

    /* Transcript styles */
    .transcript-container {
        margin-top: 1.5rem;
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--bs-border-color);
        border-radius: 0.25rem;
        padding: 1rem;
        background-color: var(--bs-body-bg);
    }
    .transcript-segment {
        margin-bottom: 0.5rem;
        padding: 0.25rem 0;
        transition: background-color 0.3s ease;
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
    }
    .transcript-segment.active {
        background-color: var(--bs-primary-bg-subtle);
        border-radius: 0.25rem;
        padding: 0.25rem 0.5rem;
    }
    .transcript-timestamp {
        color: var(--bs-primary);
        font-weight: 500;
        margin-right: 0.5rem;
        cursor: pointer;
        user-select: none;
        white-space: nowrap;
    }
    .transcript-timestamp:hover {
        text-decoration: underline;
    }
    .transcript-text {
        display: inline;
    }
    .transcript-placeholder {
        color: var(--bs-secondary-color);
        font-style: italic;
        text-align: center;
        padding: 2rem 0;
    }
    .transcript-thumbnail {
        width: 80px;
        height: 45px;
        min-width: 80px;
        background-color: #000;
        position: relative;
        overflow: hidden;
        border-radius: 0.25rem;
        border: 1px solid var(--bs-border-color);
        transition: all 0.3s ease;
    }
    .transcript-thumbnail img {
        position: absolute;
        max-width: none;
        transform: scale(0.5);
        transform-origin: top left;
        transition: all 0.3s ease;
    }
    .large-thumbnails .transcript-thumbnail {
        width: 160px;
        height: 90px;
        min-width: 160px;
    }
    .large-thumbnails .transcript-thumbnail img {
        transform: scale(1);
    }
    .transcript-content {
        flex: 1;
    }
    .transcript-indicator {
        display: inline-flex;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: var(--bs-success);
    }
    .embedding-indicator {
        display: inline-flex;
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }
    .embedding-indicator.ready {
        background-color: var(--bs-info);
    }
    .embedding-indicator.pending {
        background-color: var(--bs-secondary);
    }
    .embedding-table td, .embedding-table th {
        font-size: 0.85rem;
        vertical-align: top;
    }
    .embedding-preview {
        min-width: 360px;
        white-space: normal;
        word-break: break-word;
    }
    .embedding-meta {
        white-space: nowrap;
    }
    .embedding-id-pill {
        display: inline-block;
        font-family: var(--bs-font-monospace);
        font-size: 0.75rem;
        padding: 2px 6px;
        border: 1px solid var(--bs-border-color);
        border-radius: 999px;
        background: var(--bs-tertiary-bg);
        max-width: 180px;
        overflow: hidden;
        text-overflow: ellipsis;
        vertical-align: middle;
    }
    .embedding-copy {
        padding: 0 0.35rem;
        line-height: 1.2;
        font-size: 0.75rem;
    }
    .empty-state {
        text-align: center;
        padding: 1.5rem;
        color: var(--bs-secondary-color);
    }
</style>
{% endblock %}

{% block page_title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <div class="filter-bar">
            {% if mode == "latest" %}
            <form id="latest-filter-form" class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="range-preset" class="form-label">Range</label>
                    <select class="form-select" id="range-preset">
                        <option value="today" selected>Today</option>
                        <option value="7d">Last 7 days</option>
                        <option value="30d">Last 30 days</option>
                        <option value="90d">Last 90 days</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div class="col-md-4" id="custom-range-fields" style="display: none;">
                    <label class="form-label">Custom dates</label>
                    <div class="d-flex gap-2">
                        <input type="date" class="form-control" id="date-start">
                        <input type="date" class="form-control" id="date-end">
                    </div>
                </div>
                <div class="col-md-4">
                    <label for="camera-filter" class="form-label">Camera</label>
                    <select class="form-select" id="camera-filter">
                        <option value="">All Cameras</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Time Range</label>
                    <div class="time-range-inputs">
                        <input type="time" class="form-control" id="time-start">
                        <span>to</span>
                        <input type="time" class="form-control" id="time-end">
                    </div>
                </div>
                <div class="col-md-4 d-flex gap-2">
                    <button type="button" class="btn btn-primary" id="latest-refresh">Refresh</button>
                    <button type="button" class="btn btn-outline-secondary" id="latest-reset">Reset</button>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center gap-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="auto-refresh-toggle" checked>
                            <label class="form-check-label" for="auto-refresh-toggle">Auto-refresh</label>
                        </div>
                        <select class="form-select w-auto" id="auto-refresh-interval">
                            <option value="10">10s</option>
                            <option value="15" selected>15s</option>
                            <option value="30">30s</option>
                            <option value="60">60s</option>
                        </select>
                    </div>
                </div>
                <div class="col-12">
                    <div class="filter-hint" id="latest-hint">Showing the most recent events for the selected range.</div>
                </div>
            </form>
            {% else %}
            <form id="search-form" class="row g-3 align-items-end">
                <div class="col-md-6">
                    <label for="search-filter" class="form-label">Keyword</label>
                    <input type="text" class="form-control" id="search-filter" placeholder="Search transcripts...">
                </div>
                <div class="col-md-3">
                    <label for="search-mode" class="form-label">Mode</label>
                    <select class="form-select" id="search-mode">
                        <option value="hybrid" selected>Hybrid</option>
                        <option value="bm25">BM25 only</option>
                        <option value="vector">Vector only</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="camera-filter" class="form-label">Camera</label>
                    <select class="form-select" id="camera-filter">
                        <option value="">All Cameras</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <div class="form-check form-switch mt-4">
                        <input class="form-check-input" type="checkbox" id="snippet-toggle" checked>
                        <label class="form-check-label" for="snippet-toggle">Show excerpts</label>
                    </div>
                </div>
                <div class="col-md-3">
                    <label for="date-start" class="form-label">Date Start</label>
                    <input type="date" class="form-control" id="date-start">
                </div>
                <div class="col-md-3">
                    <label for="date-end" class="form-label">Date End</label>
                    <input type="date" class="form-control" id="date-end">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Time Range</label>
                    <div class="time-range-inputs">
                        <input type="time" class="form-control" id="time-start">
                        <span>to</span>
                        <input type="time" class="form-control" id="time-end">
                    </div>
                </div>
                <div class="col-md-3 d-flex gap-2">
                    <button type="submit" class="btn btn-primary" id="search-submit">Search</button>
                    <button type="button" class="btn btn-outline-secondary" id="search-reset">Reset</button>
                </div>
                <div class="col-12">
                    <div class="filter-hint" id="search-hint">Submit a keyword and date range to explore transcripts.</div>
                </div>
            </form>
            {% endif %}
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title mb-0">Event Results</h5>
                    <div class="results-meta" id="results-meta"></div>
                </div>
            </div>
            <div id="event-list" class="card-body event-list">
                <div class="empty-state" id="event-list-empty">Loading events...</div>
            </div>
            <div class="card-footer bg-transparent" id="load-more-container" style="display: none;">
                <button class="btn btn-outline-secondary w-100" id="load-more">Load older events</button>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 id="video-title" class="card-title mb-0">Select an event</h5>
            </div>
            <div class="card-body">
                <div class="video-container">
                    <media-controller>
                        <video 
                            id="video-player"
                            slot="media"
                            preload="auto"
                            playsinline
                            muted
                            >
                            <track kind="captions" src="" label="English" default>
                        </video>
                        <media-control-bar>
                            <media-play-button></media-play-button>
                            <media-seek-backward-button seekoffset="1"></media-seek-backward-button>
                            <media-seek-forward-button seekoffset="1"></media-seek-forward-button>
                            <media-time-range></media-time-range>
                            <media-time-display></media-time-display>
                            <media-playback-rate-button></media-playback-rate-button>
                            <media-mute-button></media-mute-button>
                            <media-volume-range></media-volume-range>
                            <media-captions-button></media-captions-button>
                            <media-fullscreen-button></media-fullscreen-button>
                        </media-control-bar>
                    </media-controller>
                </div>
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Transcript</h5>
                        <div class="d-flex gap-3 align-items-center">
                            <button id="thumbnail-size-toggle" class="btn btn-sm btn-outline-secondary" title="Toggle thumbnail size">
                                <i class="bi bi-arrows-angle-expand"></i>
                            </button>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="auto-scroll-toggle" checked>
                                <label class="form-check-label" for="auto-scroll-toggle">Auto-scroll</label>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="transcript-container" class="transcript-container">
                            <div class="transcript-placeholder">
                                Select a video to view its transcript
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Embeddings</h5>
                    </div>
                    <div class="card-body">
                        <div id="embedding-inspector" class="small text-muted">
                            Select a video to inspect embedding status and chunks
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const mode = "{{ mode }}";
    const DEFAULT_LIMIT = 200;
    let currentEvent = null;
    const videoPlayer = document.getElementById('video-player');
    let transcriptData = [];
    let activeSegmentId = null;
    let autoScroll = true;
    let largeThumbnails = false;
    let isLoading = false;
    let nextCursor = null;
    let loadedEventIds = new Set();
    let autoRefreshTimer = null;
    let showSnippets = true;

    let currentFilters = {
        dateStart: null,
        dateEnd: null,
        camera_id: '',
        timeStart: '',
        timeEnd: '',
        q: '',
        search_mode: 'hybrid'
    };

    function formatDate(date) {
        return date.toISOString().split('T')[0];
    }

    function addDays(baseDate, days) {
        const copy = new Date(baseDate.getTime());
        copy.setDate(copy.getDate() + days);
        return copy;
    }

    function setListEmptyMessage(message) {
        let empty = document.getElementById('event-list-empty');
        if (!empty) {
            empty = document.createElement('div');
            empty.id = 'event-list-empty';
            empty.className = 'empty-state';
            document.getElementById('event-list').appendChild(empty);
        }
        empty.textContent = message;
        empty.style.display = 'block';
    }

    function hideEmptyMessage() {
        const empty = document.getElementById('event-list-empty');
        if (empty) {
            empty.style.display = 'none';
        }
    }

    function updateResultsMeta(count, latencyMs) {
        const meta = document.getElementById('results-meta');
        if (!meta) return;
        if (count === null) {
            meta.textContent = '';
            return;
        }
        const total = loadedEventIds.size;
        const showing = count === 0 ? total : total;
        let text = `${showing} events shown`;
        if (typeof latencyMs === 'number') {
            text += ` â€¢ ${latencyMs} ms`;
        }
        meta.textContent = text;
    }

    function initializeFilters() {
        const today = new Date();
        const urlFilters = readFiltersFromUrl();
        if (mode === 'latest') {
            initializeLatestFilters(today, urlFilters);
        } else {
            initializeSearchFilters(today, urlFilters);
        }

        loadCameras();

        if (mode === 'latest') {
            refreshLatest();
        } else {
            if (urlFilters && Object.keys(urlFilters).length > 0) {
                runSearch();
            } else {
                setListEmptyMessage('Run a search to see results.');
                updateResultsMeta(0);
            }
        }
    }

    function initializeLatestFilters(today, urlFilters) {
        const rangeSelect = document.getElementById('range-preset');
        const customFields = document.getElementById('custom-range-fields');
        const dateStartInput = document.getElementById('date-start');
        const dateEndInput = document.getElementById('date-end');
        const autoRefreshToggle = document.getElementById('auto-refresh-toggle');
        const autoRefreshInterval = document.getElementById('auto-refresh-interval');

        function applyRangePreset(value) {
            if (!dateStartInput || !dateEndInput) return;
            const end = formatDate(today);
            let start = end;
            if (value === '7d') {
                start = formatDate(addDays(today, -6));
            } else if (value === '30d') {
                start = formatDate(addDays(today, -29));
            } else if (value === '90d') {
                start = formatDate(addDays(today, -89));
            } else if (value === 'today') {
                start = end;
            }

            dateStartInput.value = start;
            dateEndInput.value = end;
            currentFilters.dateStart = start;
            currentFilters.dateEnd = end;
        }

        if (rangeSelect) {
            rangeSelect.addEventListener('change', () => {
                if (rangeSelect.value === 'custom') {
                    if (customFields) {
                        customFields.style.display = 'block';
                    }
                } else {
                    if (customFields) {
                        customFields.style.display = 'none';
                    }
                    applyRangePreset(rangeSelect.value);
                    refreshLatest();
                }
            });
        }

        if (dateStartInput && dateEndInput) {
            dateStartInput.addEventListener('change', refreshLatest);
            dateEndInput.addEventListener('change', refreshLatest);
        }

        document.getElementById('camera-filter').addEventListener('change', refreshLatest);
        document.getElementById('time-start').addEventListener('change', refreshLatest);
        document.getElementById('time-end').addEventListener('change', refreshLatest);

        const refreshButton = document.getElementById('latest-refresh');
        if (refreshButton) {
            refreshButton.addEventListener('click', refreshLatest);
        }

        const resetButton = document.getElementById('latest-reset');
        if (resetButton) {
            resetButton.addEventListener('click', () => {
                if (rangeSelect) {
                    rangeSelect.value = 'today';
                }
                if (customFields) {
                    customFields.style.display = 'none';
                }
                applyRangePreset('today');
                document.getElementById('camera-filter').value = '';
                document.getElementById('time-start').value = '';
                document.getElementById('time-end').value = '';
                currentFilters.camera_id = '';
                currentFilters.timeStart = '';
                currentFilters.timeEnd = '';
                refreshLatest();
            });
        }

        if (autoRefreshToggle && autoRefreshInterval) {
            const updateAutoRefresh = () => {
                if (autoRefreshTimer) {
                    clearInterval(autoRefreshTimer);
                    autoRefreshTimer = null;
                }
                if (autoRefreshToggle.checked) {
                    const seconds = parseInt(autoRefreshInterval.value, 10);
                    autoRefreshTimer = setInterval(refreshLatest, seconds * 1000);
                }
            };
            autoRefreshToggle.addEventListener('change', updateAutoRefresh);
            autoRefreshInterval.addEventListener('change', updateAutoRefresh);
            updateAutoRefresh();
        }

        if (urlFilters?.date_start || urlFilters?.date_end) {
            if (rangeSelect) {
                rangeSelect.value = 'custom';
            }
            if (customFields) {
                customFields.style.display = 'block';
            }
            if (dateStartInput && urlFilters.date_start) {
                dateStartInput.value = urlFilters.date_start;
            }
            if (dateEndInput && urlFilters.date_end) {
                dateEndInput.value = urlFilters.date_end;
            }
            currentFilters.dateStart = dateStartInput?.value || '';
            currentFilters.dateEnd = dateEndInput?.value || '';
        } else if (urlFilters?.range && rangeSelect) {
            rangeSelect.value = urlFilters.range;
            if (urlFilters.range === 'custom') {
                if (customFields) {
                    customFields.style.display = 'block';
                }
            } else {
                if (customFields) {
                    customFields.style.display = 'none';
                }
                applyRangePreset(urlFilters.range);
            }
        } else {
            applyRangePreset('today');
        }

        if (urlFilters?.camera_id) {
            document.getElementById('camera-filter').value = urlFilters.camera_id;
        }
        if (urlFilters?.time_start) {
            document.getElementById('time-start').value = urlFilters.time_start;
        }
        if (urlFilters?.time_end) {
            document.getElementById('time-end').value = urlFilters.time_end;
        }
    }

    function initializeSearchFilters(today, urlFilters) {
        const dateStartInput = document.getElementById('date-start');
        const dateEndInput = document.getElementById('date-end');
        const searchForm = document.getElementById('search-form');
        const resetButton = document.getElementById('search-reset');
        const snippetToggle = document.getElementById('snippet-toggle');

        const startDate = formatDate(addDays(today, -29));
        const endDate = formatDate(today);

        if (dateStartInput) {
            dateStartInput.value = urlFilters?.date_start || startDate;
        }
        if (dateEndInput) {
            dateEndInput.value = urlFilters?.date_end || endDate;
        }

        currentFilters.dateStart = dateStartInput?.value || startDate;
        currentFilters.dateEnd = dateEndInput?.value || endDate;

        if (searchForm) {
            searchForm.addEventListener('submit', (event) => {
                event.preventDefault();
                runSearch();
            });
        }

        if (snippetToggle) {
            if (urlFilters?.show_snippets === 'false') {
                snippetToggle.checked = false;
                showSnippets = false;
            }
            snippetToggle.addEventListener('change', () => {
                showSnippets = snippetToggle.checked;
                reRenderEvents();
            });
        }

        if (resetButton) {
            resetButton.addEventListener('click', () => {
                document.getElementById('search-filter').value = '';
                document.getElementById('camera-filter').value = '';
                document.getElementById('time-start').value = '';
                document.getElementById('time-end').value = '';
                if (snippetToggle) {
                    snippetToggle.checked = true;
                }
                if (dateStartInput) dateStartInput.value = startDate;
                if (dateEndInput) dateEndInput.value = endDate;
                currentFilters = {
                    dateStart: startDate,
                    dateEnd: endDate,
                    camera_id: '',
                    timeStart: '',
                    timeEnd: '',
                    q: '',
                    search_mode: 'hybrid'
                };
                document.getElementById('search-mode').value = 'hybrid';
                showSnippets = true;
                clearResults();
                setListEmptyMessage('Run a search to see results.');
                updateResultsMeta(0);
            });
        }

        if (urlFilters?.q) {
            document.getElementById('search-filter').value = urlFilters.q;
        }
        if (urlFilters?.search_mode) {
            const modeValue = urlFilters.search_mode;
            if (['hybrid', 'bm25', 'vector'].includes(modeValue)) {
                document.getElementById('search-mode').value = modeValue;
            }
        }
        if (urlFilters?.camera_id) {
            document.getElementById('camera-filter').value = urlFilters.camera_id;
        }
        if (urlFilters?.time_start) {
            document.getElementById('time-start').value = urlFilters.time_start;
        }
        if (urlFilters?.time_end) {
            document.getElementById('time-end').value = urlFilters.time_end;
        }
    }

    function updateFiltersFromForm() {
        currentFilters = {
            dateStart: document.getElementById('date-start')?.value || '',
            dateEnd: document.getElementById('date-end')?.value || '',
            camera_id: document.getElementById('camera-filter')?.value || '',
            timeStart: document.getElementById('time-start')?.value || '',
            timeEnd: document.getElementById('time-end')?.value || '',
            q: document.getElementById('search-filter')?.value || '',
            search_mode: document.getElementById('search-mode')?.value || 'hybrid'
        };
    }

    function refreshLatest() {
        updateFiltersFromForm();
        updateUrlFromFilters();
        fetchEvents({ append: false });
    }

    function runSearch() {
        updateFiltersFromForm();
        updateUrlFromFilters();
        fetchEvents({ append: false });
    }

    function readFiltersFromUrl() {
        const url = new URL(window.location.href);
        const params = url.searchParams;
        const filters = {};
        const keys = [
            'date_start',
            'date_end',
            'camera_id',
            'time_start',
            'time_end',
            'q',
            'search_mode',
            'range',
            'show_snippets'
        ];
        keys.forEach(key => {
            if (params.has(key)) {
                filters[key] = params.get(key);
            }
        });
        return filters;
    }

    function updateUrlFromFilters() {
        const url = new URL(window.location.href);
        const params = url.searchParams;
        const keepVideo = params.get('video');
        params.forEach((_, key) => {
            if (key !== 'video') {
                params.delete(key);
            }
        });

        if (currentFilters.dateStart) params.set('date_start', currentFilters.dateStart);
        if (currentFilters.dateEnd) params.set('date_end', currentFilters.dateEnd);
        if (currentFilters.camera_id) params.set('camera_id', currentFilters.camera_id);
        if (currentFilters.timeStart) params.set('time_start', currentFilters.timeStart);
        if (currentFilters.timeEnd) params.set('time_end', currentFilters.timeEnd);
        if (currentFilters.q) params.set('q', currentFilters.q);
        if (currentFilters.search_mode && mode !== 'latest') params.set('search_mode', currentFilters.search_mode);

        if (mode === 'latest') {
            const rangeSelect = document.getElementById('range-preset');
            if (rangeSelect && rangeSelect.value) {
                params.set('range', rangeSelect.value);
            }
        } else {
            params.set('show_snippets', showSnippets ? 'true' : 'false');
        }

        if (keepVideo) {
            params.set('video', keepVideo);
        }

        window.history.replaceState({}, '', url);
    }

    function buildQueryParams(includeCursor) {
        const params = new URLSearchParams();
        if (currentFilters.dateStart) {
            params.append('date_start', currentFilters.dateStart);
        }
        if (currentFilters.dateEnd) {
            params.append('date_end', currentFilters.dateEnd);
        }
        if (currentFilters.camera_id) {
            params.append('camera_id', currentFilters.camera_id);
        }
        const normalizedTimeStart = normalizeTimeValue(currentFilters.timeStart);
        const normalizedTimeEnd = normalizeTimeValue(currentFilters.timeEnd);
        if (normalizedTimeStart) {
            params.append('time_start', normalizedTimeStart);
        }
        if (normalizedTimeEnd) {
            params.append('time_end', normalizedTimeEnd);
        }
        if (currentFilters.q) {
            params.append('q', currentFilters.q);
        }
        if (mode !== 'latest' && currentFilters.search_mode) {
            params.append('search_mode', currentFilters.search_mode);
        }
        params.append('limit', DEFAULT_LIMIT.toString());
        if (includeCursor && nextCursor) {
            params.append('cursor_start', nextCursor.event_start.toString());
            params.append('cursor_event_id', nextCursor.event_id);
        }
        return params;
    }

    function normalizeTimeValue(value) {
        if (!value) return '';
        return value.length === 5 ? `${value}:00` : value;
    }

    function clearResults() {
        const listDiv = document.getElementById('event-list');
        listDiv.innerHTML = '';
        loadedEventIds.clear();
        nextCursor = null;
        updateLoadMore();
    }

    function reRenderEvents() {
        const listDiv = document.getElementById('event-list');
        const items = listDiv.querySelectorAll('.event-item');
        items.forEach(item => {
            const snippet = item.querySelector('.event-snippet');
            if (snippet) {
                snippet.style.display = showSnippets ? 'block' : 'none';
            }
        });
    }

    function fetchEvents({ append }) {
        if (isLoading) return;
        isLoading = true;
        const listDiv = document.getElementById('event-list');
        if (!append) {
            clearResults();
            setListEmptyMessage('Loading events...');
        }

        const params = buildQueryParams(append);
        fetch(`/api/events?${params.toString()}`, {
            headers: { 'Accept': 'application/json' }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data || !Array.isArray(data.events)) {
                console.warn('Expected events page payload, got:', data);
                data = { events: [], next_cursor: null };
            }

            if (!append) {
                listDiv.innerHTML = '';
            }

            const events = data.events;
            if (events.length === 0 && loadedEventIds.size === 0) {
                setListEmptyMessage('No events found for these filters.');
            } else {
                hideEmptyMessage();
                renderEvents(events, append);
            }

            nextCursor = data.next_cursor;
            updateLoadMore();
            updateResultsMeta(events.length, data.latency_ms);
        })
        .catch(error => {
            console.error('Error fetching events:', error);
            listDiv.innerHTML = '<p class="text-danger">Error loading events. Please try refreshing the page.</p>';
            updateLoadMore();
        })
        .finally(() => {
            isLoading = false;
        });
    }

    function updateLoadMore() {
        const container = document.getElementById('load-more-container');
        const button = document.getElementById('load-more');
        if (!container || !button) return;
        if (nextCursor) {
            container.style.display = 'block';
            button.disabled = false;
        } else {
            container.style.display = 'none';
            button.disabled = true;
        }
    }

    function renderEvents(events, append) {
        const listDiv = document.getElementById('event-list');
        const filteredEvents = events.filter(event => !loadedEventIds.has(event.event_id));
        if (filteredEvents.length === 0) {
            return;
        }

        const html = filteredEvents.map(t => {
            loadedEventIds.add(t.event_id);
            const duration = Math.max(Math.round(t.event_end - t.event_start), 1);
            const cameraLabel = t.camera_name || t.camera_id;
            const snippet = t.snippet ? `<div class="event-snippet small text-muted mt-1" style="display:${showSnippets ? 'block' : 'none'}">${renderSnippet(t.snippet)}</div>` : '';
            const matchQuality = renderMatchQuality(t);
            const embeddingTitle = t.has_embeddings ? 'Embeddings available' : 'Embeddings pending';
            return `
                <div class="event-item p-2 border-bottom"
                     onclick="loadVideo('${t.event_id}')"
                     onmouseenter="startPreview('${t.event_id}', this, ${duration})"
                     onmouseleave="stopPreview(this)">
                    <div class="fw-bold d-flex align-items-center gap-2">
                        <span>${cameraLabel}</span>
                        ${t.has_transcript ? `
                            <span class="transcript-indicator" title="Transcript available" aria-hidden="true"></span>
                            <span class="visually-hidden">Transcript available</span>
                        ` : ''}
                        <span class="embedding-indicator ${t.has_embeddings ? 'ready' : 'pending'}" title="${embeddingTitle}" aria-hidden="true"></span>
                        <span class="visually-hidden">${embeddingTitle}</span>
                    </div>
                    <div class="small text-muted">${formatTimestamp(t.event_start)} - ${duration} seconds</div>
                    ${snippet}
                    ${matchQuality}
                    <div class="event-preview">
                        <img>
                    </div>
                </div>
            `;
        }).join('');

        if (append) {
            listDiv.insertAdjacentHTML('beforeend', html);
        } else {
            listDiv.innerHTML = html;
        }
    }

    function formatTimestamp(timestamp) {
        return new Date(timestamp * 1000).toLocaleString();
    }

    function renderSnippet(snippet) {
        if (!snippet) return '';
        const escaped = snippet
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;');
        return escaped
            .replaceAll('[[H]]', '<mark>')
            .replaceAll('[[/H]]', '</mark>');
    }

    function formatScore(value, decimals = 5) {
        if (typeof value !== 'number' || !Number.isFinite(value)) return null;
        return value.toFixed(decimals);
    }

    function renderMatchQuality(item) {
        const hybridRaw = item.hybrid_score ?? item.score;
        const bm25Raw = item.bm25_rrf_score ?? item.bm25_score;
        const vectorSimRaw = item.vector_similarity;
        const hybrid = formatScore(hybridRaw);
        const bm25 = formatScore(bm25Raw);
        const vectorSim = formatScore(vectorSimRaw, 4);
        const bm25Rank = Number.isInteger(item.bm25_rank) ? `#${item.bm25_rank}` : null;
        const vectorRank = Number.isInteger(item.vector_rank) ? `#${item.vector_rank}` : null;
        const sources = Array.isArray(item.match_sources) && item.match_sources.length > 0
            ? item.match_sources.join('+')
            : null;
        if (!hybrid && !bm25 && !vectorSim && !bm25Rank && !vectorRank && !sources) return '';
        const parts = [];
        if (hybrid) parts.push(`Hybrid ${hybrid}`);
        if (bm25) parts.push(`BM25 ${bm25}`);
        if (vectorSim) parts.push(`Vector sim ${vectorSim}`);
        if (bm25Rank) parts.push(`BM25 rank ${bm25Rank}`);
        if (vectorRank) parts.push(`Vector rank ${vectorRank}`);
        if (sources) parts.push(`Sources ${escapeHtml(sources)}`);
        return `<div class="match-quality mt-1"><span class="label">Match:</span> ${parts.join(' | ')}</div>`;
    }

    function loadCameras() {
        fetch('/api/cameras', {
            headers: { 'Accept': 'application/json' }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data || !data.cameras || !Array.isArray(data.cameras)) {
                console.warn('Expected array of cameras, got:', data);
                return;
            }
            updateCameraDropdown(data.cameras);
        })
        .catch(error => {
            console.error('Error fetching cameras:', error);
        });
    }

    function updateCameraDropdown(cameras) {
        const select = document.getElementById('camera-filter');
        const currentValue = select.value;

        while (select.options.length > 1) {
            select.remove(1);
        }

        cameras
            .sort((a, b) => a.name.localeCompare(b.name))
            .forEach(camera => {
                const option = new Option(camera.name, camera.id);
                select.add(option);
            });

        if (currentValue) {
            const cameraExists = cameras.some(camera => camera.id === currentValue);
            if (cameraExists) {
                select.value = currentValue;
            }
        }
    }

    function loadVideo(eventId) {
        if (!eventId || typeof eventId !== 'string' || !/^[a-zA-Z0-9-]+$/.test(eventId)) {
            console.error('Invalid event ID format');
            return;
        }
        const newUrl = new URL(window.location);
        newUrl.searchParams.set('video', eventId);
        window.history.pushState({}, '', newUrl);

        const transcriptContainer = document.getElementById('transcript-container');
        const embeddingInspector = document.getElementById('embedding-inspector');
        transcriptContainer.innerHTML = '<div class="p-3 text-center"><div class="spinner-border spinner-border-sm" role="status"></div> Loading transcript...</div>';
        embeddingInspector.innerHTML = '<div class="p-2"><div class="spinner-border spinner-border-sm" role="status"></div> Loading embedding status...</div>';
        transcriptData = [];
        activeSegmentId = null;

        videoPlayer.removeEventListener('timeupdate', updateActiveTranscriptSegment);

        fetch(`/api/event/${encodeURIComponent(eventId)}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data || typeof data !== 'object') {
                throw new Error('Invalid event data received');
            }

            currentEvent = data;
            const title = document.getElementById('video-title');
            videoPlayer.pause();

            const tracks = videoPlayer.getElementsByTagName('track');
            while (tracks.length > 0) {
                tracks[0].parentNode.removeChild(tracks[0]);
            }

            videoPlayer.removeAttribute('src');
            videoPlayer.load();

            setTimeout(() => {
                videoPlayer.src = `/video/${encodeURIComponent(eventId)}`;

                if (data.has_transcript) {
                    const captionTrack = document.createElement('track');
                    captionTrack.kind = 'captions';
                    captionTrack.label = 'English';
                    captionTrack.src = `/api/captions/${encodeURIComponent(eventId)}`;
                    captionTrack.default = true;
                    videoPlayer.appendChild(captionTrack);

                    loadTranscript(eventId);
                } else {
                    transcriptContainer.innerHTML = '<div class="transcript-placeholder">No transcript available for this video</div>';
                }

                loadEmbeddingInspector(eventId);

                const storyboardTrack = document.createElement('track');
                storyboardTrack.kind = 'metadata';
                storyboardTrack.label = 'thumbnails';
                storyboardTrack.src = `/api/storyboard/vtt/${encodeURIComponent(eventId)}`;
                storyboardTrack.default = true;
                videoPlayer.appendChild(storyboardTrack);

                let titleText = `${data.camera_name || data.camera_id} - ${formatTimestamp(data.event_start)}`;
                if (!data.has_transcript) {
                    titleText += ' (Transcription pending)';
                }
                title.textContent = titleText;
            }, 100);
        })
        .catch(error => {
            console.error('Error loading event:', error);
            document.getElementById('video-title').textContent = 'Error loading video';
            const newUrl = new URL(window.location);
            newUrl.searchParams.delete('video');
            window.history.pushState({}, '', newUrl);
            transcriptContainer.innerHTML = '<div class="transcript-placeholder">Error loading transcript</div>';
            document.getElementById('embedding-inspector').innerHTML = '<div class="text-danger">Error loading embedding status</div>';
        });
    }

    function escapeHtml(value) {
        return String(value || '')
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;');
    }

    function formatMs(ms) {
        if (ms === null || ms === undefined) return 'n/a';
        return `${(ms / 1000).toFixed(1)}s`;
    }

    function formatEmbeddingId(id) {
        if (!id) return '';
        if (id.length <= 16) return id;
        return `${id.slice(0, 8)}...${id.slice(-6)}`;
    }

    function formatEmbeddingTime(epochSecs) {
        if (!epochSecs) return '';
        return new Date(epochSecs * 1000).toLocaleString();
    }

    async function copyEmbeddingId(event, buttonEl) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        const id = buttonEl?.dataset?.embeddingId || '';
        if (!id) return;

        let copied = false;
        if (navigator.clipboard && window.isSecureContext) {
            try {
                await navigator.clipboard.writeText(id);
                copied = true;
            } catch (_) {
                copied = false;
            }
        }

        if (!copied) {
            const textarea = document.createElement('textarea');
            textarea.value = id;
            textarea.setAttribute('readonly', '');
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                copied = document.execCommand('copy');
            } catch (_) {
                copied = false;
            }
            document.body.removeChild(textarea);
        }

        const originalLabel = buttonEl.textContent;
        buttonEl.textContent = copied ? 'Copied' : 'Failed';
        setTimeout(() => {
            buttonEl.textContent = originalLabel;
        }, 1000);
    }

    function loadEmbeddingInspector(eventId) {
        fetch(`/api/event/${encodeURIComponent(eventId)}/embeddings`, {
            headers: { 'Accept': 'application/json' }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const container = document.getElementById('embedding-inspector');
            const summary = `
                <div class="mb-2">
                    <strong>Units:</strong> ${data.embedded_units}/${data.total_units}
                    &nbsp;|&nbsp;<strong>Pending jobs:</strong> ${data.pending_jobs}
                    &nbsp;|&nbsp;<strong>Failed jobs:</strong> ${data.failed_jobs}
                </div>
            `;

            if (!Array.isArray(data.units) || data.units.length === 0) {
                container.innerHTML = `${summary}<div class="text-muted">No transcript chunks indexed yet for this event.</div>`;
                return;
            }

            const rows = data.units.map(unit => `
                <tr>
                    <td><code>${escapeHtml(unit.unit_type)}</code></td>
                    <td>${formatMs(unit.start_ms)} - ${formatMs(unit.end_ms)}</td>
                    <td>${unit.has_embedding ? '<span class="badge text-bg-info">embedded</span>' : '<span class="badge text-bg-secondary">pending</span>'}</td>
                    <td class="embedding-meta">
                        ${unit.has_embedding
                            ? `
                                <span class="badge text-bg-light border">${escapeHtml(unit.model_key || 'model')}</span>
                                <span class="badge text-bg-light border">${escapeHtml(unit.embedding_dim || '?')}d</span>
                                <span class="embedding-id-pill" title="${escapeHtml(unit.embedding_id || '')}">${escapeHtml(formatEmbeddingId(unit.embedding_id || ''))}</span>
                                <button type="button" class="btn btn-outline-secondary btn-sm embedding-copy" title="Copy embedding id" data-embedding-id="${escapeHtml(unit.embedding_id || '')}" onclick="copyEmbeddingId(event, this)">Copy</button>
                                <div class="text-muted">${escapeHtml(formatEmbeddingTime(unit.embedding_created_at))}</div>
                              `
                            : '<span class="text-muted">queued / not generated</span>'}
                    </td>
                    <td class="embedding-preview">${escapeHtml(unit.content_preview)}</td>
                </tr>
            `).join('');

            container.innerHTML = `
                ${summary}
                <div class="table-responsive">
                    <table class="table table-sm embedding-table mb-0">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Span</th>
                                <th>Status</th>
                                <th>Embedding</th>
                                <th>Chunk Preview</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
        })
        .catch(error => {
            console.error('Error loading embedding inspector:', error);
            document.getElementById('embedding-inspector').innerHTML = '<div class="text-danger">Error loading embedding status</div>';
        });
    }

    window.addEventListener('popstate', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const videoId = urlParams.get('video');
        if (videoId) {
            loadVideo(videoId);
        } else {
            videoPlayer.src = '';
            document.getElementById('video-title').textContent = 'Select an event';
            currentEvent = null;
        }
    });

    document.getElementById('load-more')?.addEventListener('click', () => {
        if (nextCursor) {
            fetchEvents({ append: true });
        }
    });

    let currentPreviewInterval = null;
    let previewVttData = {};

    async function startPreview(eventId, element, duration) {
        const preview = element.querySelector('.event-preview');
        const previewImg = preview.querySelector('img');

        preview.style.display = 'block';
        previewImg.src = `/api/storyboard/image/${eventId}`;

        if (currentPreviewInterval) {
            clearInterval(currentPreviewInterval);
        }

        if (!previewVttData[eventId]) {
            try {
                const response = await fetch(`/api/storyboard/vtt/${eventId}`);
                const vttText = await response.text();
                previewVttData[eventId] = parseVTT(vttText);
            } catch (error) {
                console.error('Error loading preview VTT:', error);
                return;
            }
        }

        let currentTime = 0;
        const fps = 4;

        currentPreviewInterval = setInterval(() => {
            currentTime = (currentTime + 1) % Math.ceil(duration);
            const frame = previewVttData[eventId].find(f =>
                currentTime >= f.startTime && currentTime <= f.endTime
            );

            if (frame) {
                const [x, y] = frame.position;
                previewImg.style.left = `-${x}px`;
                previewImg.style.top = `-${y}px`;
            }
        }, 1000 / fps);
    }

    function stopPreview(element) {
        const preview = element.querySelector('.event-preview');
        preview.style.display = 'none';

        if (currentPreviewInterval) {
            clearInterval(currentPreviewInterval);
            currentPreviewInterval = null;
        }
    }

    function parseVTT(vttText) {
        const frames = [];
        const lines = vttText.split('\n');
        let currentFrame = null;

        for (const line of lines) {
            if (line.includes('-->')) {
                const [start, end] = line.split('-->').map(timeStr => {
                    const [h, m, s] = timeStr.trim().split(':').map(Number);
                    return h * 3600 + m * 60 + s;
                });
                currentFrame = { startTime: start, endTime: end };
            } else if (line.includes('#xywh=') && currentFrame) {
                const xywh = line.split('#xywh=')[1].split(',').map(Number);
                currentFrame.position = xywh;
                frames.push(currentFrame);
                currentFrame = null;
            }
        }

        return frames;
    }

    function formatTimeDisplay(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);

        if (hours > 0) {
            return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }

    function loadTranscript(eventId) {
        fetch(`/api/captions/${encodeURIComponent(eventId)}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.text();
        })
        .then(vttContent => {
            transcriptData = parseTranscriptVTT(vttContent);
            renderTranscript();
            videoPlayer.addEventListener('timeupdate', updateActiveTranscriptSegment);
        })
        .catch(error => {
            console.error('Error loading transcript:', error);
            const transcriptContainer = document.getElementById('transcript-container');
            transcriptContainer.innerHTML = '<div class="transcript-placeholder">Error loading transcript</div>';
        });
    }

    function parseTranscriptVTT(vttContent) {
        const lines = vttContent.split('\n');
        const segments = [];
        let currentSegment = null;

        let i = 0;
        while (i < lines.length && !lines[i].includes('-->')) {
            i++;
        }

        for (; i < lines.length; i++) {
            const line = lines[i].trim();

            if (line.includes('-->')) {
                const [start, end] = line.split('-->').map(t => {
                    const parts = t.trim().split(':');
                    const seconds = parseFloat(parts[parts.length - 1]);
                    const minutes = parseInt(parts[parts.length - 2]);
                    const hours = parts.length > 2 ? parseInt(parts[0]) : 0;
                    return hours * 3600 + minutes * 60 + seconds;
                });

                currentSegment = {
                    id: `segment-${segments.length}`,
                    start,
                    end,
                    text: ''
                };
            } else if (line !== '' && currentSegment) {
                currentSegment.text += (currentSegment.text ? ' ' : '') + line;
            } else if (line === '' && currentSegment && currentSegment.text) {
                segments.push(currentSegment);
                currentSegment = null;
            }
        }

        if (currentSegment && currentSegment.text) {
            segments.push(currentSegment);
        }

        return segments;
    }

    function renderTranscript() {
        const transcriptContainer = document.getElementById('transcript-container');

        if (transcriptData.length === 0) {
            transcriptContainer.innerHTML = '<div class="transcript-placeholder">No transcript available</div>';
            return;
        }

        const html = transcriptData.map(segment => `
            <div id="${segment.id}" class="transcript-segment">
                <div class="transcript-thumbnail" onclick="seekToTime(${segment.start})">
                    <img src="/api/storyboard/image/${currentEvent.event_id}" data-segment-time="${segment.start}" alt="Preview">
                </div>
                <div class="transcript-content">
                    <span class="transcript-timestamp" onclick="seekToTime(${segment.start})">
                        ${formatTimeDisplay(segment.start)}
                    </span>
                    <span class="transcript-text">${segment.text}</span>
                </div>
            </div>
        `).join('');

        transcriptContainer.innerHTML = html;
        updateThumbnailPositions();
    }

    function updateThumbnailPositions() {
        if (!transcriptData.length || !currentEvent) return;

        if (!previewVttData[currentEvent.event_id]) {
            fetch(`/api/storyboard/vtt/${currentEvent.event_id}`)
            .then(response => response.text())
            .then(vttText => {
                previewVttData[currentEvent.event_id] = parseVTT(vttText);
                positionThumbnailImages();
            })
            .catch(error => {
                console.error('Error loading storyboard VTT data:', error);
            });
        } else {
            positionThumbnailImages();
        }
    }

    function positionThumbnailImages() {
        if (!currentEvent || !previewVttData[currentEvent.event_id]) return;

        const vttData = previewVttData[currentEvent.event_id];
        const thumbnailImages = document.querySelectorAll('.transcript-thumbnail img');

        thumbnailImages.forEach(img => {
            const segmentTime = parseFloat(img.dataset.segmentTime);
            const frame = findFrameForTime(vttData, segmentTime);

            if (frame) {
                const [x, y] = frame.position;

                if (largeThumbnails) {
                    img.style.left = `-${x}px`;
                    img.style.top = `-${y}px`;
                } else {
                    img.style.left = `-${x / 2}px`;
                    img.style.top = `-${y / 2}px`;
                }
            }
        });
    }

    function findFrameForTime(vttData, time) {
        return vttData.find(frame => time >= frame.startTime && time <= frame.endTime) ||
               (time > vttData[vttData.length - 1]?.endTime ? vttData[vttData.length - 1] : vttData[0]);
    }

    function seekToTime(seconds) {
        if (videoPlayer) {
            videoPlayer.currentTime = seconds;
            videoPlayer.play().catch(e => console.error('Error playing video:', e));
        }
    }

    function updateActiveTranscriptSegment() {
        if (!videoPlayer || transcriptData.length === 0) return;

        const currentTime = videoPlayer.currentTime;
        let activeSegment = null;

        for (const segment of transcriptData) {
            if (currentTime >= segment.start && currentTime <= segment.end) {
                activeSegment = segment;
                break;
            }
        }

        if (!activeSegment && currentTime > transcriptData[transcriptData.length - 1].end) {
            activeSegment = transcriptData[transcriptData.length - 1];
        }

        if (!activeSegment || (activeSegmentId && activeSegment.id === activeSegmentId)) {
            return;
        }

        if (activeSegmentId) {
            const prevElement = document.getElementById(activeSegmentId);
            if (prevElement) {
                prevElement.classList.remove('active');
            }
        }

        const currentElement = document.getElementById(activeSegment.id);
        if (currentElement) {
            currentElement.classList.add('active');
            activeSegmentId = activeSegment.id;

            if (autoScroll) {
                const container = document.getElementById('transcript-container');
                const elementTop = currentElement.offsetTop;
                const containerHeight = container.clientHeight;
                const scrollPosition = elementTop - (containerHeight / 2);

                container.scrollTo({
                    top: scrollPosition,
                    behavior: 'smooth'
                });
            }
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const autoScrollToggle = document.getElementById('auto-scroll-toggle');
        autoScrollToggle.addEventListener('change', function() {
            autoScroll = this.checked;
        });

        const thumbnailSizeToggle = document.getElementById('thumbnail-size-toggle');
        thumbnailSizeToggle.addEventListener('click', function() {
            largeThumbnails = !largeThumbnails;
            const container = document.getElementById('transcript-container');

            if (largeThumbnails) {
                container.classList.add('large-thumbnails');
                this.innerHTML = '<i class="bi bi-arrows-angle-contract"></i>';
            } else {
                container.classList.remove('large-thumbnails');
                this.innerHTML = '<i class="bi bi-arrows-angle-expand"></i>';
            }

            positionThumbnailImages();
        });

        videoPlayer.addEventListener('loadedmetadata', function() {
            if (currentEvent && transcriptData.length > 0) {
                updateThumbnailPositions();
            }
        });

        initializeFilters();

        const urlParams = new URLSearchParams(window.location.search);
        const videoId = urlParams.get('video');
        if (videoId) {
            loadVideo(videoId);
        }
    });

    window.seekToTime = seekToTime;
</script>
{% endblock %}
